# 处理机调度
## 处理机调度概念
进程切换是CPU资源的当前占用者的切换，保存当前进程在PCB中的执行上下文（CPU状态），恢复下一个进程的执行上下文。

处理机调度是从就绪队列中找一个占用CPU的进程，从多个可用CPU中挑选就绪进程可使用的CPU资源。

## 调度准则
### 调度时机
操作系统维护进程的状态序列。进程从运行状态切换到等待状态，这样CPU就空闲了，或者进程被终结了，CPU又空闲了。这两种情况对应着非抢占系统，当前进程主动放弃CPU。对可抢占系统，中断请求被服务例程响应完成，或当前进程因为时间片用完时会被抢占，进程从等待切换到就绪，这时更急迫的想占用CPU，也会发生抢占。

### 调度策略
进程在CPU计算和IO操作间交替，在时间片机制下，进程可能在结束当前CPU计算之前就被迫放弃CPU。

CPU使用率：CPU处于忙状态的时间百分比。

吞吐率：单位时间内完成的进程数量

周转时间：进程从初始化到结束（包括等待）的时间

等待时间：进程在就绪队列中的时间

响应时间：从提交请求到产生相应所花费的时间

调度算法希望“更快”的服务。

响应时间目标：
- 减少相应时间，及时处理输入请求
- 减少平均响应时间的波动，提高可预测性
- 低延迟调度改善了交互体验

吞吐量目标：
- 增加吞吐量，减少开销（操作系统开销，上下文切换）
- 系统资源的高效利用（CPU、IO）
- 减少等待时间，提高响应性能和吞吐量性能
- 吞吐量是系统的计算带宽

公平性目标：
- 保证每个进程占用相同的CPU时间
- 公平通常会增加响应时间

## 先来先服务、短进程优先和最高响应比优先调度算法
### 先来先服务
按照就绪队列的先后顺序排列，进程进入等待或结束状态时，就绪队列中的下一个进程占用CPU。

周转时间：每个进程的平均总时间（等待+执行）

优点：简单，排队依据容易获得。

缺点： 平均等待时间波动大，排队位置对算法影响大，IO和CPU资源利用效率低。

### 短进程优先
考虑进程的特征，选择就绪队列中执行时间最短进程占用CPU进入运行状态。它具有最好的平均周转时间。

但可能导致饥饿，连续的短进程会使长进程无法获得CPU资源。且需要预知未来，可以用历史执行时间预估未来的执行时间。

### 最高响应比优先
考虑进程在就绪队列中的等待时间。选择就绪队列中响应比R最高的进程。`R = (w + s) / s`，w是等待时间，s是执行时间。这种算法基于短进程优先算法，不可抢占，关注了进程等待时间，以防止无限等待。

## 时间片轮转、多级反馈队列、公平共享调度算法和ucore调度框架
### 时间片轮转
时间片是分配处理机资源的基本时间单元，各个进程占用一个时间片，仍按照先来先服务策略，时间片结束时按照先来先服务切换到下一个就绪进程，每隔(n-1)个时间片进程执行一个时间片。

时间片太大的话，等待时间过长，退化成先来先服务；若太短，产生了大量上下文切换，影响系统吞吐量。

这时需要选择一个合适的时间片长度。

### 多级反馈队列
就绪队列排成多个子队列，不同队列可以有不同算法，进程可以在队列之间转换。队列间的调度可以采用时间片方法。

多级反馈队列：进程在不同队列间移动的多级队列算法。时间片大小随优先级级别增加而增加，如进程在当前的时间片没有完成，则降到下一个优先级。CPU密集型的进程优先级下降很快，这样时间片会增大，IO密集型的则优先级上升。

### 公平共享调度算法
注重资源访问的公平，一些用户比另一些用户重要，保证不重要的组无法垄断资源。未使用的资源按照比例分配，没有达到资源使用率目标的组获得更高的优先级。

### uCore的调度队列run_queue
```
struct run_queue{
	list_entry_t run_list;
	unsigned int proc_num;
	int max_time_slice;
	list_entry_t rq_link;
}
```

## 实时调度和多处理器调度
实时调度对时间有要求，实时操作系统的正确性以来其时间和功能两方面，其性能指标是时间约束的及时性。

周期实时任务：一系列相似任务，任务有规律的重复，周期p=任务请求时间间隔，执行时间e=最大执行时间，使用率U=e/p。

硬实时是指错过任务时限会导致灾难性或非常严重的后果，必须验证，在最坏情况下能满足时限。软实时是指尽量满足任务时限。

速率单调调度算法：通过周期安排优先级，周期越短优先级越高，执行周期最短的任务；

最早截止时间优先算法：截止时间越早优先级越高，执行截止时间最早的任务。

### 多处理器调度
针对多个处理机，处理机之间可以负载共享。

对阵多处理机（SMP）调度：每个处理器运行自己的调度程序，调度程序对共享资源的访问需要同步。

静态进程分配：进程开始执行到结束都被分配到一个固定的处理机上，每个处理机都有自己的就绪队列，调度开销小，但各个处理机可能忙闲不均。

动态进程分配：进程在执行中可以分配到任意空闲处理机执行，所有处理机共享一个公共的就绪队列，调度开销大，各个处理机的负载是均衡的。

## 优先级反置
操作系统中出现高优先级进程长时间等待低优先级进程所占用的资源的现象。

优先级继承：占用资源的低优先级进程继承申请资源的高优先级进程的优先级。只有占有资源的低优先级进程被阻塞时才能提高占有资源进程的优先级。

优先级天花板协议：占有资源进程的优先级和所有可能申请该资源的进程的最高优先级相同，不管是否发生等待，都提升占有资源进程的优先级。优先级高于系统中所有被锁定的资源的优先级上限，任务执行临界区就不会被阻塞。

